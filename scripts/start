#!/usr/bin/env bash
#
# ComfyUI Launcher
# ================
# Starts ComfyUI service and opens the web UI in a browser.
#
# Usage:
#   flox activate -s -- start
#
# Requires:
#   - flox services (for service management)
#   - curl (for health check)
#   - xdg-open or open (for browser, optional)

set -e

PORT="${COMFYUI_PORT:-8188}"
URL="http://localhost:${PORT}"

# Start service if not already running
if ! flox services status comfyui 2>/dev/null | grep -q "Running"; then
    echo "Starting ComfyUI service..."
    flox services start comfyui
fi

# Wait for server to be ready
echo "Waiting for ComfyUI to be ready..."
max_attempts=60
attempt=0
while ! curl -s "$URL" >/dev/null 2>&1; do
    sleep 0.5
    attempt=$((attempt + 1))
    if [ $attempt -ge $max_attempts ]; then
        echo "Timeout waiting for ComfyUI to start"
        echo "Check logs with: flox services logs comfyui"
        exit 1
    fi
done

echo "ComfyUI is ready at $URL"

# Open browser
if command -v xdg-open &>/dev/null; then
    xdg-open "$URL"
elif command -v open &>/dev/null; then
    open "$URL"
else
    echo "Open $URL in your browser"
fi
