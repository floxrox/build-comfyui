#!/usr/bin/env bash
#
# ComfyUI Environment Setup
# =========================
# Sets up the ComfyUI runtime environment on activation.
# Called from the Flox manifest [hook] on-activate.
#
# Required environment variables (set by Flox):
#   FLOX_ENV           - Path to Flox environment
#   FLOX_ENV_CACHE     - Path to environment cache
#   COMFYUI_WORK_DIR   - User work directory
#   COMFYUI_PORT       - Server port
#   COMFYUI_EXTRA_MODEL_PATHS - Path to extra_model_paths.yaml
#
# Optional environment variables:
#   COMFYUI_RESET              - Set to 1 to force re-bootstrap
#   COMFYUI_INSTALL_WORKFLOWS  - Set to 1 to copy bundled workflows
#   COMFYUI_OVERWRITE_WORKFLOWS - Set to 1 to overwrite existing workflows

set -e

# Runtime version marker for cache invalidation
RUNTIME_VERSION="1.0.0"

# Allow user to force reset: COMFYUI_RESET=1 flox activate
if [ "${COMFYUI_RESET:-0}" = "1" ]; then
  if [ -n "$FLOX_ENV_CACHE" ] && [ -d "$FLOX_ENV_CACHE" ]; then
    echo "COMFYUI_RESET=1 detected - clearing environment cache..."
    rm -rf "$FLOX_ENV_CACHE"
    echo "Cache cleared. Environment will be re-bootstrapped."
  else
    echo "WARNING: FLOX_ENV_CACHE not set or doesn't exist, skipping reset."
  fi
fi

setup_comfyui() {
  local venv="$FLOX_ENV_CACHE/venv"
  local comfyui_source="$FLOX_ENV/share/comfyui"
  local comfyui_runtime="$FLOX_ENV_CACHE/comfyui-runtime"

  # Helper: Get package requirement from ComfyUI's requirements.txt
  # Returns the full requirement line (e.g., "comfyui-frontend-package==1.38.14")
  # Returns empty string if package not found
  get_comfyui_requirement() {
    local package="$1"
    local req_file="$comfyui_source/requirements.txt"
    if [ -f "$req_file" ]; then
      grep "^${package}[=><!]" "$req_file" 2>/dev/null | head -1
    fi
  }

  # Verify ComfyUI source is available from Flox package
  if [ ! -d "$comfyui_source" ] || [ ! -f "$comfyui_source/main.py" ]; then
    echo "ERROR: ComfyUI source not found at $comfyui_source"
    echo "The comfyui package may not be installed correctly."
    return 1
  fi

  # Create work directory structure
  mkdir -p "$COMFYUI_WORK_DIR"/{models,output,input,user,custom_nodes}
  mkdir -p "$FLOX_ENV_CACHE"/{temp,uv,pip,logs}

  # Create runtime directory that mirrors store with writable custom_nodes
  # This allows ComfyUI to find both Flox-packaged and user-installed nodes
  if [ ! -d "$comfyui_runtime" ] || [ ! -f "$comfyui_runtime/.runtime_version" ] || \
     [ "$(cat "$comfyui_runtime/.runtime_version" 2>/dev/null)" != "$RUNTIME_VERSION" ]; then
    echo "Setting up ComfyUI runtime directory..."
    rm -rf "$comfyui_runtime"
    mkdir -p "$comfyui_runtime"

    # Symlink all files/dirs from store EXCEPT custom_nodes, models, and web
    # (custom_nodes needs to be writable for user nodes, models for downloads, web for extensions)
    for item in "$comfyui_source"/*; do
      item_name=$(basename "$item")
      if [ "$item_name" != "custom_nodes" ] && [ "$item_name" != "models" ] && [ "$item_name" != "web" ]; then
        ln -sfn "$item" "$comfyui_runtime/$item_name"
      fi
    done

    # Create writable custom_nodes directory
    mkdir -p "$comfyui_runtime/custom_nodes"

    # Symlink models to user's work directory (writable, for node downloads)
    ln -sfn "$COMFYUI_WORK_DIR/models" "$comfyui_runtime/models"

    # Copy web directory (some custom nodes need to write to web/extensions)
    if [ -d "$comfyui_source/web" ]; then
      echo "Copying web directory for writable extensions..."
      cp -rL --no-preserve=mode,ownership "$comfyui_source/web" "$comfyui_runtime/web"
    fi

    # Mark version for cache invalidation
    echo "$RUNTIME_VERSION" > "$comfyui_runtime/.runtime_version"
  fi

  # COPY community custom nodes to user's work directory (if not already there)
  # This allows users to modify the nodes while keeping upstream versions as reference
  # Nodes from comfyui-custom-nodes package are copied, not symlinked
  local custom_nodes_store="$FLOX_ENV/share/comfyui/custom_nodes"
  local user_custom_nodes="$COMFYUI_WORK_DIR/custom_nodes"

  if [ -d "$custom_nodes_store" ]; then
    for node_dir in "$custom_nodes_store"/*; do
      if [ -d "$node_dir" ]; then
        node_name=$(basename "$node_dir")
        target="$user_custom_nodes/$node_name"

        # Skip Impact Pack and Subpack - these are symlinked directly to runtime
        if [[ "$node_name" == "ComfyUI-Impact-Pack" ]] || [[ "$node_name" == "ComfyUI-Impact-Subpack" ]]; then
          # Symlink Impact Pack and Subpack directly to runtime (read-only)
          ln -sfn "$node_dir" "$comfyui_runtime/custom_nodes/$node_name"
          continue
        fi

        # Copy node to user work directory if it doesn't exist
        # Use -L to follow symlinks (Nix store may contain symlinks)
        if [ ! -d "$target" ]; then
          echo "Installing custom node: $node_name"
          cp -rL --no-preserve=mode,ownership "$node_dir" "$target"
        fi
      fi
    done
  fi

  # Copy bundled example workflows
  # Default: copy only if no workflows exist yet
  # COMFYUI_INSTALL_WORKFLOWS=1: copy, skip existing files
  # COMFYUI_OVERWRITE_WORKFLOWS=1: copy, overwrite existing files
  local bundled_workflows="$FLOX_ENV/share/comfyui/workflows"
  local user_workflows="$COMFYUI_WORK_DIR/user/default/workflows"

  if [ -d "$bundled_workflows" ]; then
    local do_copy=0
    local do_overwrite=0

    if [ "${COMFYUI_OVERWRITE_WORKFLOWS:-0}" = "1" ]; then
      do_copy=1
      do_overwrite=1
    elif [ "${COMFYUI_INSTALL_WORKFLOWS:-0}" = "1" ]; then
      do_copy=1
    elif [ ! -d "$user_workflows" ] || [ -z "$(ls -A "$user_workflows" 2>/dev/null)" ]; then
      do_copy=1
    fi

    if [ "$do_copy" = "1" ]; then
      for family_dir in "$bundled_workflows"/*/; do
        [ -d "$family_dir" ] || continue
        family=$(basename "$family_dir")
        mkdir -p "$user_workflows/$family"
        for wf in "$family_dir"*.json; do
          [ -f "$wf" ] || continue
          wf_name=$(basename "$wf")
          if [ "$do_overwrite" = "1" ] || [ ! -f "$user_workflows/$family/$wf_name" ]; then
            cp --no-preserve=mode,ownership "$wf" "$user_workflows/$family/$wf_name"
          fi
        done
      done
    fi
  fi

  # Link all user custom_nodes to runtime (including copied Flox nodes)
  if [ -d "$user_custom_nodes" ]; then
    for node_dir in "$user_custom_nodes"/*; do
      if [ -d "$node_dir" ] || [ -L "$node_dir" ]; then
        node_name=$(basename "$node_dir")
        target="$comfyui_runtime/custom_nodes/$node_name"
        # Skip backup directories
        if [[ "$node_name" == *.backup-* ]]; then
          continue
        fi
        # Skip if already exists in runtime (Impact Pack/Subpack)
        if [ -e "$target" ]; then
          continue
        fi
        ln -sfn "$node_dir" "$target"
      fi
    done
  fi

  # Create extra_model_paths.yaml if it doesn't exist
  if [ ! -f "$COMFYUI_EXTRA_MODEL_PATHS" ]; then
    cat > "$COMFYUI_EXTRA_MODEL_PATHS" << 'YAML'
# ComfyUI Extra Model Paths Configuration
# Add additional model directories here

comfyui_work:
    base_path: ~/comfyui-work/models
    checkpoints: checkpoints/
    clip: clip/
    clip_vision: clip_vision/
    controlnet: controlnet/
    embeddings: embeddings/
    gligen: gligen/
    hypernetworks: hypernetworks/
    loras: loras/
    photomaker: photomaker/
    style_models: style_models/
    unet: unet/
    upscale_models: upscale_models/
    vae: vae/
    vae_approx: vae_approx/
    diffusion_models: diffusion_models/

# Note: Impact Pack models are stored in custom_nodes/ComfyUI-Impact-Pack/models/
YAML
    echo "Created $COMFYUI_EXTRA_MODEL_PATHS"
  fi

  # Create and activate virtual environment with system packages
  if [ ! -d "$venv" ]; then
    echo "Creating Python virtual environment with system packages..."
    uv venv "$venv" --python "$FLOX_ENV/bin/python3" --system-site-packages
    # Invalidate deps marker since venv is fresh - forces pip install
    rm -f "$FLOX_ENV_CACHE/.comfyui_deps_installed"
  fi

  # Add venv to PATH for this script only
  if [ -d "$venv/bin" ]; then
    export PATH="$venv/bin:$PATH"
  fi

  # Install ComfyUI dependencies if not already done
  if [ ! -f "$FLOX_ENV_CACHE/.comfyui_deps_installed" ]; then
    echo "Installing ComfyUI dependencies..."

    # Detect GPU availability for informational purposes
    if lspci 2>/dev/null | grep -E 'NVIDIA|AMD' > /dev/null; then
      echo "GPU detected - CUDA-enabled PyTorch will be available from Flox"
    else
      echo "No GPU detected - CPU PyTorch will be used"
    fi

    # IMPORTANT: PyTorch is provided by Flox packages, do NOT install via pip
    echo "Installing ComfyUI Python dependencies..."

    # Install packages that don't depend on torch
    uv pip install --python "$venv/bin/python" \
      comfyui-workflow-templates==0.8.15 \
      comfyui-embedded-docs==0.4.0 \
      "safetensors>=0.4.2"

    # Install frontend package (version from ComfyUI's requirements.txt)
    frontend_req=$(get_comfyui_requirement "comfyui-frontend-package")
    if [ -n "$frontend_req" ]; then
      echo "Installing $frontend_req..."
      uv pip install --python "$venv/bin/python" "$frontend_req"
    else
      echo "WARNING: Could not determine frontend version, using fallback..."
      uv pip install --python "$venv/bin/python" "comfyui-frontend-package>=1.37.11"
    fi

    # Install comfy-kitchen without deps to avoid pulling torch from PyPI
    uv pip install --python "$venv/bin/python" --no-deps "comfy-kitchen>=0.2.7"

    # Install only the non-torch dependencies of spandrel
    uv pip install --python "$venv/bin/python" typing_extensions

    # Install kornia only on non-x86_64-linux platforms
    if [ "$(uname -m)" != "x86_64" ] || [ "$(uname -s)" != "Linux" ]; then
      echo "Installing kornia via pip (not available in Flox for this platform)..."
      uv pip install --no-deps --python "$venv/bin/python" "kornia>=0.7.1"
      uv pip install --python "$venv/bin/python" kornia-rs
    fi

    # Install comfy-aimdo if required by this ComfyUI version
    aimdo_req=$(get_comfyui_requirement "comfy-aimdo")
    if [ -n "$aimdo_req" ]; then
      echo "Installing $aimdo_req..."
      uv pip install --python "$venv/bin/python" "$aimdo_req"
    fi

    touch "$FLOX_ENV_CACHE/.comfyui_deps_installed"
    echo "ComfyUI dependencies installed successfully"
  fi
}

setup_comfyui

# Display welcome message
echo ""
echo "ComfyUI Environment Activated"
echo ""
echo "Runtime: $FLOX_ENV_CACHE/comfyui-runtime"
echo "Custom nodes: Flox packages + ~/comfyui-work/custom_nodes"
echo "Work directory: $COMFYUI_WORK_DIR"
echo "Web UI: http://localhost:$COMFYUI_PORT"
echo ""
echo "Quick start:"
echo "  start                 - Start ComfyUI and open browser"
echo ""
echo "Service management:"
echo "  flox services start   - Start ComfyUI"
echo "  flox services status  - Check service status"
echo "  flox services stop    - Stop the service"
echo ""
echo "Download models:"
echo "  comfyui-download-sd15   - Stable Diffusion 1.5  (~4.3 GB)"
echo "  comfyui-download-sdxl   - Stable Diffusion XL   (~6.9 GB)"
echo "  comfyui-download-sd35   - SD 3.5 Large           (~23 GB, needs HF_TOKEN)"
echo "  comfyui-download-flux   - FLUX.1-dev             (~22 GB, needs HF_TOKEN)"
echo ""
echo "Troubleshooting:"
echo "  COMFYUI_RESET=1 flox activate  - Force re-bootstrap environment"
echo ""
